. . ar Agent V2.1 - Real-Time Data Integration

## ğŸ¯ Overview

V2.1 transforms the Event Planner Agent from a demo with seeded data to a **production-ready system** that scrapes real-time data from Yelp and Google Maps.

---

## âœ… What's Been Implemented

### **1. MCP Scraper Server** (`mcp-servers/scraper/`)
- **Yelp Fusion API integration**
- Endpoints:
  - `POST /scrape/yelp/caterers` - Scrape caterers by location and cuisine
  - `POST /scrape/yelp/venues` - Scrape event venues by location
  - `POST /scrape/yelp/business/:id` - Get detailed business info and reviews
- **Features:**
  - Real-time ratings and reviews
  - Price levels and contact information
  - Business hours and photos
  - Coordinates for location-based queries

### **2. MCP Google Maps Server** (`mcp-servers/google-maps/`)
- **Google Maps Places API integration**
- Endpoints:
  - `POST /places/search` - Text search for places
  - `POST /places/nearby` - Find nearby places
  - `POST /places/details/:place_id` - Get detailed place information
  - `POST /geocode` - Convert addresses to coordinates
  - `POST /directions` - Get directions between locations
- **Features:**
  - Real-time place data
  - Ratings, reviews, and photos
  - Opening hours and contact info
  - Distance calculations

### **3. Database Schema Migration** (`database/migrations/001_add_external_data_support.sql`)
- **New fields added to `venues` and `caterers` tables:**
  - `external_id` - Unique ID from external source (Yelp, Google Maps)
  - `external_source` - Source of data (yelp, google_maps, manual)
  - `external_url` - Link to external listing
  - `rating` - Average rating (0-5 scale)
  - `review_count` - Number of reviews
  - `price_level` - Price indicator
  - `latitude` / `longitude` - GPS coordinates
  - `photos` - JSONB array of photo URLs
  - `business_status` - OPERATIONAL, CLOSED, etc.
  - `last_synced_at` - Timestamp of last data sync

- **New tables:**
  - `external_api_cache` - Cache API responses to reduce costs
  - `data_sync_jobs` - Track sync job status and metrics

- **New functions:**
  - `calculate_distance()` - Haversine formula for distance calculation
  - `find_nearby_venues()` - Find venues within radius
  - `find_nearby_caterers()` - Find caterers within radius

- **New views:**
  - `venues_with_external_data` - Venues with sync status
  - `caterers_with_external_data` - Caterers with sync status

### **4. Data Ingestion Service** (`app/services/data_ingestion_service.py`)
- **Scrapes and ingests data from external sources**
- Methods:
  - `scrape_yelp_caterers()` - Fetch caterers from Yelp
  - `scrape_yelp_venues()` - Fetch venues from Yelp
  - `search_google_places()` - Search Google Maps
  - `ingest_caterer()` - Save caterer to database
  - `ingest_venue()` - Save venue to database
  - `sync_caterers_for_location()` - Full sync for location
  - `sync_venues_for_location()` - Full sync for location

- **Features:**
  - Upsert logic (insert or update existing records)
  - Deduplication by `external_id` and `external_source`
  - Error handling and logging
  - Batch processing

### **5. Docker Compose Updates**
- Added `mcp-scraper` service (port 3003)
- Added `mcp-google-maps` service (port 3004)
- Updated API environment variables:
  - `MCP_SCRAPER_URL`
  - `MCP_GOOGLE_MAPS_URL`
  - `YELP_API_KEY`
  - `GOOGLE_MAPS_API_KEY`
- Added migrations volume to PostgreSQL

### **6. Environment Configuration**
- Updated `.env.example` with:
  - `YELP_API_KEY`
  - `GOOGLE_MAPS_API_KEY`
  - `MCP_SCRAPER_URL`
  - `MCP_GOOGLE_MAPS_URL`

---

## ğŸš€ Next Steps to Complete V2.1

### **Step 1: Get API Keys**

#### **Yelp Fusion API**
1. Go to https://www.yelp.com/developers
2. Create an app
3. Copy your API key
4. Add to `.env`:
   ```bash
   YELP_API_KEY=your_yelp_api_key_here
   ```

#### **Google Maps API**
1. Go to https://console.cloud.google.com/
2. Enable these APIs:
   - Places API
   - Geocoding API
   - Directions API
3. Create API key
4. Add to `.env`:
   ```bash
   GOOGLE_MAPS_API_KEY=your_google_maps_api_key_here
   ```

### **Step 2: Run Database Migration**
```bash
# Connect to PostgreSQL container
/Applications/Docker.app/Contents/Resources/bin/docker exec -it event-planner-db psql -U postgres -d event_planner_db

# Run migration
\i /docker-entrypoint-initdb.d/migrations/001_add_external_data_support.sql

# Verify new columns
\d venues
\d caterers

# Exit
\q
```

### **Step 3: Update API Endpoints** (TODO)
Add these endpoints to `app/main.py`:

```python
@app.post("/sync/caterers")
async def sync_caterers(
    location: str,
    use_google: bool = True,
    use_osm: bool = True
):
    """Sync caterers for a location from Google Places and/or OSM"""
    result = await data_ingestion_service.sync_caterers_for_location(
        location, use_google=use_google, use_osm=use_osm
    )
    return {"success": True, "data": result}

@app.post("/sync/venues")
async def sync_venues(
    location: str,
    use_google: bool = True,
    use_osm: bool = True
):
    """Sync venues for a location from Google Places and/or OSM"""
    result = await data_ingestion_service.sync_venues_for_location(
        location, use_google=use_google, use_osm=use_osm
    )
    return {"success": True, "data": result}
```

### **Step 4: Rebuild and Test**
```bash
# Rebuild Docker stack
/Applications/Docker.app/Contents/Resources/bin/docker compose up --build -d

# Check all services are running
/Applications/Docker.app/Contents/Resources/bin/docker compose ps

# Test Yelp scraper
curl -X POST http://localhost:3003/scrape/yelp/caterers \
  -H "Content-Type: application/json" \
  -d '{"location": "San Francisco", "cuisine": "Italian", "limit": 5}'

# Test Google Maps
curl -X POST http://localhost:3004/places/search \
  -H "Content-Type: application/json" \
  -d '{"query": "event venue", "location": "San Francisco, CA"}'

# Test data sync (once API endpoints are added)
curl -X POST "http://localhost:8000/sync/caterers?location=San Francisco&cuisines=Italian&cuisines=Mexican"

curl -X POST "http://localhost:8000/sync/venues?location=San Francisco"
```

---

## ğŸ“Š Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FastAPI Application                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Data Ingestion Service                       â”‚  â”‚
â”‚  â”‚  - Scrapes Yelp & Google Maps                        â”‚  â”‚
â”‚  â”‚  - Ingests to PostgreSQL                             â”‚  â”‚
â”‚  â”‚  - Handles deduplication                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
         â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Scraper    â”‚ â”‚  MCP Google â”‚ â”‚   PostgreSQL     â”‚
â”‚  (Yelp API)     â”‚ â”‚  Maps API   â”‚ â”‚  (Real Data)     â”‚
â”‚  Port 3003      â”‚ â”‚  Port 3004  â”‚ â”‚  Port 5432       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Yelp Fusion    â”‚ â”‚  Google     â”‚ â”‚  External Data   â”‚
â”‚  API            â”‚ â”‚  Maps API   â”‚ â”‚  + Seed Data     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Benefits of V2.1

### **Before (V2.0):**
- âŒ Static seeded data (10 venues, 10 caterers)
- âŒ No real ratings or reviews
- âŒ No location-based search
- âŒ No real-time availability
- âŒ Demo-only quality

### **After (V2.1):**
- âœ… Real-time data from Yelp & Google Maps
- âœ… Actual ratings, reviews, and photos
- âœ… GPS coordinates for distance calculations
- âœ… Hundreds of venues/caterers per location
- âœ… Production-ready data quality
- âœ… Automatic data refresh capability
- âœ… Deduplication and caching

---

## ğŸ“ˆ Data Flow

### **1. Initial Sync**
```
User â†’ POST /sync/caterers?location=SF
  â†“
Data Ingestion Service
  â†“
MCP Scraper â†’ Yelp API (fetch 50 caterers)
  â†“
PostgreSQL (upsert with external_id)
  â†“
Response: {total_scraped: 50, total_ingested: 48}
```

### **2. Event Planning (with real data)**
```
User â†’ POST /plan-event
  â†“
Catering Service â†’ PostgreSQL
  â†“
Query: SELECT * FROM caterers 
       WHERE location = 'SF' 
       AND rating >= 4.0
       ORDER BY rating DESC
  â†“
Return: Real caterers with Yelp ratings
```

---

## ğŸ”„ Sync Strategy

### **Manual Sync (V2.1)**
- Admin calls `/sync/caterers` and `/sync/venues`
- Data refreshed on-demand
- Good for initial population

### **Automated Sync (Future V2.2)**
- Cron job runs daily
- Refreshes data older than 24 hours
- Background task queue (Celery)

---

## ğŸ’° Cost Considerations

### **Yelp Fusion API**
- **Free tier:** 5,000 calls/day
- **Cost:** Free for most use cases
- **Rate limit:** 5 QPS

### **Google Maps API**
- **Places API:** $17 per 1,000 requests
- **Geocoding:** $5 per 1,000 requests
- **Free tier:** $200/month credit
- **Optimization:** Cache results in `external_api_cache` table

---

## ğŸ§ª Testing Checklist

- [ ] Get Yelp API key
- [ ] Get Google Maps API key
- [ ] Run database migration
- [ ] Update `.env` with API keys
- [ ] Rebuild Docker stack
- [ ] Test Yelp scraper health endpoint
- [ ] Test Google Maps health endpoint
- [ ] Test scraping caterers for SF
- [ ] Test scraping venues for SF
- [ ] Add sync endpoints to main.py
- [ ] Test full sync workflow
- [ ] Verify data in PostgreSQL
- [ ] Test event planning with real data

---

## ğŸ“ Files Created/Modified

### **New Files:**
- `mcp-servers/scraper/package.json`
- `mcp-servers/scraper/server.js`
- `mcp-servers/scraper/Dockerfile`
- `mcp-servers/google-maps/package.json`
- `mcp-servers/google-maps/server.js`
- `mcp-servers/google-maps/Dockerfile`
- `database/migrations/001_add_external_data_support.sql`
- `app/services/data_ingestion_service.py`

### **Modified Files:**
- `docker-compose.yml` - Added mcp-scraper and mcp-google-maps services
- `.env.example` - Added YELP_API_KEY and GOOGLE_MAPS_API_KEY
- `app/main.py` - (TODO: Add sync endpoints)

---

## ğŸš€ Ready for Production

Once V2.1 is complete, the system will:
1. âœ… Scrape real venues and caterers from Yelp
2. âœ… Enrich data with Google Maps information
3. âœ… Store in PostgreSQL with deduplication
4. âœ… Serve real-time data to users
5. âœ… Support location-based queries
6. âœ… Provide actual ratings and reviews

**This is no longer a demo - it's a real-world event planning agent!** ğŸ‰
